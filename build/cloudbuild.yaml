steps:
  - name: 'ubuntu'
    id: 'Create Artifacts Directory'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        mkdir -p artifacts
        echo "Created artifacts directory"

  - name: 'ubuntu'
    id: 'Zip Source'
    dir: src/convert-starter
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        apt-get update && apt-get install -y zip
        zip -r ../../artifacts/convert-starter.zip .

  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'Upload to GCS'
    args: ['cp', 'artifacts/convert-starter.zip', 'gs://video-converter-src-bucket/convert-starter.zip']

  - name: 'hashicorp/terraform:light'
    id: 'Terraform Init'
    dir: infra
    entrypoint: sh
    args: ['-c', 'terraform init']

  - name: 'hashicorp/terraform:light'
    id: 'Terraform Apply'
    dir: infra
    entrypoint: sh
    args: ['-c', 'terraform apply -auto-approve']

options:
  logging: CLOUD_LOGGING_ONLY

substitutions:
  _REGION: asia-northeast1
